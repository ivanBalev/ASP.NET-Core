@model BDInSelfLove.Web.ViewModels.Video.VideoPaginationViewModel
@using BDInSelfLove.Common
@using Microsoft.AspNetCore.Identity
@using BDInSelfLove.Data.Models
@using BDInSelfLove.Web.InputModels.VideoComment


@inject SignInManager<ApplicationUser> SignInManager
@inject Microsoft.AspNetCore.Mvc.Localization.IViewLocalizer localizer


@{ 
    var mainCommentsPerPage = 3;
}

<section id="videoGallery" class="py-4">
    <div class="container">
        @foreach (var video in Model.Videos)
        {
            <div class="row mb-5 pt-3 video border" itemscope itemtype="http://schema.org/Movie">
                <div class="col">
                    <div class="embed-responsive embed-responsive-21by9">
                        <iframe title="Psychotherapy video" class="embed-responsive-item" src="@video.Url"></iframe>
                    </div>

                    @if (this.User.IsInRole(GlobalConstants.AdministratorRoleName))
                    {
                        <div class="row mt-2">
                            <div class="col">
                                <a asp-area="Administration" asp-controller="Video" asp-action="Delete" 
                                   asp-route-id="@video.Id" class="btn btn-block btn-outline-danger">@localizer["Delete"]</a>
                            </div>
                        </div>
                    }

                    @if (this.SignInManager.IsSignedIn(this.User))
                    {
                        <h5 class="mt-3">@localizer["Add New Comment"]</h5>
                    }
                    <div class="row">
                        <div class="col new-comment mt-1">
                            @if (!this.SignInManager.IsSignedIn(this.User))
                            {
                                <partial name="_PostLoginPartial" model="null" /> }
                            else
                            {
                                <partial name="_AddVideoCommentPartial" model="@(new VideoCommentInputModel {
                                                                VideoId = video.Id, ParentCommentId = null })" />}
                        </div>
                    </div>
                    @if (video.VideoComments.Any())
                    {
                        <h5 class="mb-3 text-center comments-sign">@localizer["Comments"]</h5>
                        <div class="comments">
                            @foreach (var comment in video.VideoComments)
                            {
                                this.ViewData["width"] = "64";
                                this.ViewData["height"] = "64";
                                <div class="main-comment">
                                    <partial name="_CommentsPartial" model="@comment" />
                                </div>
                            }
                            @if (video.VideoComments.Count > mainCommentsPerPage)
                            {
                                <div class="row mb-2">
                                    <div class="col text-center">
                                        <button class="btn btn-outline-secondary btn-sm loadCommentsBtn">@localizer["Load More Comments"]</button>
                                    </div>
                                </div>
                            }

                        </div>
                    }
                </div>
            </div>
        }

        @*Pagination*@
        @if (Model.PagesCount > 1)
        {
            <div class="mb-3 clearfix">
                <nav>
                    <ul class="pagination justify-content-center">
                        @if (this.Model.CurrentPage == 1)
                        {
                            <li class="page-item disabled">
                                <a class="page-link" href="#">@localizer["Previous"]</a>
                            </li>
                        }
                        else
                        {
                            <li class="page-item">
                                <a class="page-link"
                                   asp-controller="Video"
                                   asp-action="All"
                                   asp-route-page="@(this.Model.CurrentPage - 1)">@localizer["Previous"]</a>
                            </li>
                        }

                        @{
                            var startPage = Model.CurrentPage > 6 ? Model.CurrentPage - 5 : 1;
                            var endPage = Model.CurrentPage + 4 > Model.PagesCount ? Model.PagesCount : Model.CurrentPage + 4;

                            for (int i = startPage; i <= endPage; i++)
                            {
                                var active = i == this.Model.CurrentPage ? "active" : string.Empty;
                                <li class="page-item @active">
                                    <a class="page-link"
                                       asp-controller="Video"
                                       asp-action="All"
                                       asp-route-page="@i">@i</a>
                                </li>
                            }
                        }

                        @if (this.Model.CurrentPage == this.Model.PagesCount)
                        {
                            <li class="page-item disabled">
                                <a class="page-link" href="#">@localizer["Next"]</a>
                            </li>
                        }
                        else
                        {
                            <li class="page-item">
                                <a class="page-link"
                                   asp-controller="Video"
                                   asp-action="All"
                                   asp-route-page="@(this.Model.CurrentPage + 1)">@localizer["Next"]</a>
                            </li>
                        }
                    </ul>
                </nav>
            </div>
        }


        @*Delete comment confirmation modal*@
        <div id="confirm-comment-delete" class="modal fade" role="dialog">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header justify-content-center">
                        <h4 class="modal-title">@localizer["Are you sure?"]</h4>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-danger btn-block delete-comment-confirm-btn">@localizer["Confirm"]</button>
                    </div>
                </div>
            </div>
        </div>

    </div>
</section>